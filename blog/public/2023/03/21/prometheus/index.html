<!DOCTYPE html>
<html lang="pt">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Prometheus | scovl</title>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Under the hood">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        mermaid.initialize({
            startOnLoad: true,
            theme: 'light',
            align: 'center'
        });
    });
</script>
 
</head>
<body>
    
    
    <header class="header">
    <div class="container">
        <div class="header-content">
            <a href="http://localhost:1313/" class="site-title">scovl</a>
            
            <nav>
                <ul class="nav-menu">
                    
                    
                    <li>
                        <a href="/page/about/" class="nav-link ">
                            About
                        </a>
                    </li>
                    
                    <li>
                        <a href="/page/contact/" class="nav-link ">
                            Contact
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </div>
    </div>
</header> 
    
    
    
    <main>
        <div class="container">
            
<article class="post">
    <header class="post-header">
        <h1 class="post-title">Prometheus</h1>
        <div class="post-meta">
            
            <time datetime="2023-03-21T23:18:18-03:00">
                Tue, Mar 21, 2023
            </time>
            
            
            
            
            
            <div class="post-tags">
                
                <a href="/tags/prometheus/" class="tag">Prometheus</a>
                
                <a href="/tags/grafana/" class="tag">Grafana</a>
                
                <a href="/tags/monitoring/" class="tag">Monitoring</a>
                
                <a href="/tags/tsdb/" class="tag">TSDB</a>
                
                <a href="/tags/devops/" class="tag">DevOps</a>
                
                <a href="/tags/observability/" class="tag">Observability</a>
                
            </div>
            
            
            
            <div class="reading-time">
                Estimated reading time: 29 min
            </div>
            
            
            
            <div class="post-description">
                Under the hood
            </div>
            
        </div>
    </header>
    
    <div class="post-content">
        <h2 id="√≠ndice">√çndice</h2>
<ul>
<li><strong><a href="/2023/03/21/prometheus/#introdu%c3%a7%c3%a3o">Introdu√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#instala%c3%a7%c3%a3o">Instala√ß√£o</a></strong>
<ul>
<li><strong><a href="/2023/03/21/prometheus/#modo-agent-v233">Modo Agent (v2.33+)</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#instala%c3%a7%c3%a3o-padr%c3%a3o">Instala√ß√£o Padr√£o</a></strong></li>
</ul>
</li>
<li><strong><a href="/2023/03/21/prometheus/#promtool">Promtool</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#instrumenta%c3%a7%c3%a3o">Instrumenta√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#alertmanager">Alertmanager</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#pushgateway">PushGateway</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#federa%c3%a7%c3%a3o">Federa√ß√£o</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#under-the-hood">Under the Hood</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#promql">PromQL</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#recursos-modernos-do-prometheus">Recursos Modernos do Prometheus</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#melhores-pr%c3%a1ticas">Melhores Pr√°ticas</a></strong></li>
<li><strong><a href="/2023/03/21/prometheus/#conclus%c3%a3o">Conclus√£o</a></strong></li>
</ul>
<h2 id="introdu√ß√£o">Introdu√ß√£o</h2>
<h3 id="prometheus">Prometheus</h3>
<p>O <a href="https://prometheus.io/">Prometheus</a> √© uma ferramenta de monitoramento de sistemas e aplicativos open source que revolucionou a forma como pensamos sobre observabilidade em ambientes distribu√≠dos. Desenvolvido para fornecer uma abordagem eficiente de coletar, armazenar e analisar m√©tricas de desempenho, o Prometheus se destaca por sua arquitetura simples mas poderosa, alta escalabilidade e modelo de dados dimensional.</p>
<p>O Prometheus foi projetado desde o in√≠cio para trabalhar perfeitamente em ambientes containerizados como <a href="https://kubernetes.io/">Kubernetes</a> e <a href="https://www.docker.com/">Docker</a>, tornando-o uma escolha natural para monitoramento nativo da nuvem. Frequentemente √© utilizado em conjunto com <a href="https://grafana.com/">Grafana</a> para visualiza√ß√µes avan√ßadas, criando um poderoso ecossistema de observabilidade.</p>
<p>A ferramenta foi criada em 2012 por uma equipe liderada por Julius Volz na SoundCloud, quando a empresa precisava de uma solu√ß√£o de monitoramento mais robusta. Em 2016, o projeto foi transferido para a <strong><a href="https://www.cncf.io/">Cloud Native Computing Foundation (CNCF)</a></strong>, iniciando seu per√≠odo de incuba√ß√£o. Em 9 de agosto de 2018, o Prometheus se tornou o segundo projeto a atingir o status de &ldquo;graduado&rdquo; na CNCF, demonstrando sua maturidade, ado√ß√£o pela comunidade e estabilidade como projeto open source.</p>
<blockquote>
<p><strong>NOTA</strong>: Para um mergulho profundo na linguagem de consulta PromQL, veja nossa se√ß√£o dedicada <strong><a href="/2023/03/21/prometheus/#promql">abaixo</a></strong>.</p></blockquote>
<h3 id="tipos-de-m√©tricas">Tipos de m√©tricas</h3>
<p>O Prometheus suporta quatro tipos principais de m√©tricas: <strong>Counter</strong>, <strong>Gauge</strong>, <strong>Histogram</strong> e <strong>Summary</strong>. Para detalhes completos sobre cada tipo, consulte a <a href="https://prometheus.io/docs/concepts/metric_types/">documenta√ß√£o oficial de m√©tricas</a>.</p>
<h3 id="monitoramento-pull-vs-push">Monitoramento pull vs push</h3>
<p>O Prometheus utiliza um modelo <strong>pull-based</strong>, onde ele periodicamente solicita dados dos targets configurados. Para detalhes sobre o modelo de coleta, consulte a <a href="https://prometheus.io/docs/introduction/overview/#architecture">documenta√ß√£o oficial</a>.</p>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-pullvspush.png" alt="img"></p>
<h3 id="arquitetura-do-prometheus">Arquitetura do Prometheus</h3>
<p>O Prometheus √© composto por um servidor principal que coleta e armazena m√©tricas, bibliotecas cliente para instrumenta√ß√£o, PushGateway para jobs de curta dura√ß√£o, exportadores para sistemas externos e Alertmanager para gerenciamento de alertas.</p>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/refs/heads/main/blog/content/post/images/tsdb/arch.png" alt="img"></p>
<p>Para detalhes completos sobre a arquitetura, consulte a <a href="https://prometheus.io/docs/introduction/overview/#architecture">documenta√ß√£o oficial</a>.</p>
<h3 id="labels-e-samples">Labels e Samples</h3>
<p>Labels s√£o pares chave-valor que identificam e categorizam m√©tricas. Para conven√ß√µes de nomenclatura e detalhes sobre labels internas, consulte a <a href="https://prometheus.io/docs/concepts/data_model/">documenta√ß√£o oficial</a>.</p>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/master/post/images/tsdb/samples01.png" alt="img"></p>
<h2 id="instala√ß√£o">Instala√ß√£o</h2>
<p>Existem in√∫meras maneiras de instalar o <a href="https://prometheus.io/">Prometheus</a>, mas aqui vamos mostrar como instalar o Prometheus usando o <a href="https://www.docker.com/">Docker</a> e o <a href="https://docs.docker.com/compose/">Docker Compose</a>, <a href="https://grafana.com/">Grafana</a> e o <a href="https://github.com/dmitsh/promsim">PromSim</a> um simulador de m√©tricas para testar o Prometheus e Grafana.</p>
<h3 id="modo-agent-v233">Modo Agent (v2.33+)</h3>
<p>O Prometheus oferece um modo especial chamado &ldquo;Agent&rdquo; que √© otimizado para deployments write-only, reduzindo drasticamente o uso de disco e CPU. O modo Agent √© ideal quando voc√™ usa remote write para enviar dados para sistemas externos como Thanos, Cortex ou VictoriaMetrics.</p>
<h4 id="caracter√≠sticas-do-modo-agent">Caracter√≠sticas do modo Agent:</h4>
<ul>
<li><strong>Sem armazenamento local</strong>: N√£o armazena dados no TSDB local</li>
<li><strong>Baixo uso de recursos</strong>: Consome significativamente menos CPU e disco</li>
<li><strong>Remote write otimizado</strong>: Focado em coletar e enviar dados</li>
<li><strong>Sem consultas locais</strong>: N√£o suporta consultas PromQL locais</li>
<li><strong>Sem alertas locais</strong>: Alertas devem ser configurados no sistema de destino</li>
</ul>
<h4 id="configura√ß√£o-do-modo-agent">Configura√ß√£o do modo Agent:</h4>


  <pre><code class="language-yaml"># prometheus-agent.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: &#39;node-exporter&#39;
    static_configs:
      - targets: [&#39;node-exporter:9100&#39;]

remote_write:
  - url: &#34;http://thanos-receive:10908/api/v1/receive&#34;
    remote_timeout: 30s</code></pre>
 <p>Executando em modo Agent via Docker Compose:</p>


  <pre><code class="language-bash"># Docker
docker run -p 9090:9090 \
  -v ./prometheus-agent.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus:latest \
  --enable-feature=agent

# Docker Compose
version: &#34;3&#34;
services:
  prometheus-agent:
    image: prom/prometheus:latest
    command:
      - &#39;--enable-feature=agent&#39;
      - &#39;--config.file=/etc/prometheus/prometheus.yml&#39;
    ports:
      - &#34;9090:9090&#34;
    volumes:
      - &#34;./prometheus-agent.yml:/etc/prometheus/prometheus.yml&#34;</code></pre>
 <h3 id="instala√ß√£o-padr√£o">Instala√ß√£o Padr√£o</h3>
<p>Crie um arquivo de configura√ß√£o do Docker Compose chamado <code>docker-compose.yml</code> no mesmo diret√≥rio que o arquivo prometheus.yml. Inclua as seguintes configura√ß√µes:</p>


  <pre><code class="language-yaml">version: &#34;3&#34;

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - &#34;9090:9090&#34;
    volumes:
      - &#34;./prometheus.yml:/etc/prometheus/prometheus.yml&#34;
    depends_on:
      - promsim

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - &#34;3000:3000&#34;

  promsim:
    image: sysdigtraining/promsim:latest
    container_name: promsim
    ports:
      - &#34;8080:8080&#34;</code></pre>
 <p>Em seguida, crie um arquivo de configura√ß√£o do <a href="https://prometheus.io/">Prometheus</a> chamado <code>prometheus.yml</code> no mesmo diret√≥rio que o arquivo <code>docker-compose.yml</code>. Inclua as seguintes configura√ß√µes:</p>


  <pre><code class="language-yaml">global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: &#34;promsim&#34;
    static_configs:
      - targets: [&#34;promsim:8080&#34;]</code></pre>
 <p>No terminal, navegue at√© o diret√≥rio onde voc√™ salvou o docker-compose.yml e execute o seguinte comando para iniciar os servi√ßos:</p>


  <pre><code class="language-bash">docker-compose up -d</code></pre>
 <p>No Grafana, voc√™ precisar√° adicionar o Prometheus como uma fonte de dados (datasource). Fa√ßa login no Grafana (usu√°rio padr√£o: admin, senha: admin), v√° para &ldquo;Configuration&rdquo; (√≠cone de engrenagem) e clique em &ldquo;Data Sources&rdquo;. Adicione uma nova fonte de dados com o tipo Prometheus e use a URL <strong>http://prometheus:9090</strong>. Agora voc√™ pode criar pain√©is no Grafana usando m√©tricas do Prometheus e do PromSim. O PromSim ir√° gerar m√©tricas simuladas que voc√™ pode usar para testar o comportamento do threshold. O PromSim √© um simulador de m√©tricas que gera m√©tricas aleat√≥rias para testar o Prometheus. Para mais informa√ß√µes sobre o PromSim, consulte a documenta√ß√£o oficial em <strong><a href="https://github.com/dmitsh/promsim">https://github.com/dmitsh/promsim</a></strong>.</p>
<p>Se voc√™ quiser instalar somente o Prometheus, basta rodar <code>docker run -p 9090:9090 prom/prometheus</code>. Voc√™ pode acessar a interface web do Prometheus em <strong>http://localhost:9090</strong>. Para mais informa√ß√µes sobre como instalar o Prometheus, consulte a <a href="https://prometheus.io/docs/prometheus/latest/getting_started/">documenta√ß√£o oficial</a>.</p>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/master/post/images/tsdb/ui01.png" alt="img"></p>
<p>A interface do Prometheus √© composta pelos seguintes menus:</p>
<ul>
<li><strong>Alerts</strong>: este menu exibe todos os alertas ativos e permite visualizar o hist√≥rico de alertas. Os alertas s√£o disparados quando uma determinada m√©trica ultrapassa um limite configurado.</li>
<li><strong>Graph</strong>: este menu permite criar e visualizar gr√°ficos de m√©tricas coletadas pelo Prometheus. O usu√°rio pode definir a escala do eixo X e Y, bem como personalizar a apar√™ncia do gr√°fico.</li>
<li><strong>Status</strong>: este menu exibe o status atual do Prometheus, incluindo informa√ß√µes sobre as m√©tricas coletadas, alertas ativos e configura√ß√µes do sistema.</li>
<li><strong>Help</strong>: este menu fornece informa√ß√µes √∫teis sobre o Prometheus, incluindo documenta√ß√£o, exemplos de consulta e informa√ß√µes de contato da equipe de suporte.</li>
<li><strong>Classic UI</strong>: este menu oferece uma interface alternativa para visualiza√ß√£o de m√©tricas, com recursos adicionais em compara√ß√£o com a interface padr√£o.</li>
</ul>
<p>Al√©m disso, a interface do Prometheus cont√©m as seguintes op√ß√µes:</p>
<ul>
<li><strong>Use local time</strong>: essa op√ß√£o permite que o usu√°rio visualize as m√©tricas em seu fuso hor√°rio local em vez do hor√°rio do servidor.</li>
<li><strong>Enable query history</strong>: essa op√ß√£o permite que o usu√°rio acesse o hist√≥rico de consultas que foram executadas anteriormente.</li>
<li><strong>Enable autocomplete</strong>: essa op√ß√£o permite que o usu√°rio obtenha sugest√µes de consulta enquanto digita no campo de consulta.</li>
<li><strong>Campo de consulta</strong>: este √© o campo onde o usu√°rio pode inserir consultas PromQL para recuperar m√©tricas espec√≠ficas.</li>
<li><strong>Campo Table e Graph</strong>: este campo permite que o usu√°rio selecione entre exibir o resultado da consulta como uma tabela ou um gr√°fico.</li>
<li><strong>Evaluation time</strong>: este campo permite que o usu√°rio especifique o per√≠odo de tempo para o qual as m√©tricas devem ser recuperadas pela consulta.</li>
</ul>
<h3 id="configura√ß√£o">Configura√ß√£o</h3>
<p>O Prometheus √© configurado atrav√©s de um arquivo YAML que define todos os aspectos do comportamento do sistema. A configura√ß√£o √© dividida em se√ß√µes l√≥gicas que controlam diferentes aspectos do funcionamento.</p>
<h4 id="estrutura-de-diret√≥rios">Estrutura de Diret√≥rios</h4>
<p>No geral a estrutura de diret√≥rios do Prometheus √© a seguinte:</p>


  <pre><code class="language-bash">/opt/prometheus/
‚îú‚îÄ‚îÄ console_libraries/
‚îÇ   ‚îú‚îÄ‚îÄ prom.lib.js
‚îÇ   ‚îú‚îÄ‚îÄ react-16.8.3.production.min.js
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ consoles/
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ queries_range.html
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ prometheus
‚îú‚îÄ‚îÄ prometheus.yml
‚îú‚îÄ‚îÄ promtool
‚îî‚îÄ‚îÄ ...</code></pre>
 <p>Pode variar a depender da vers√£o, mas a estrutura acima √© a mais comum. Os arquivos <code>prometheus</code> e <code>promtool</code> s√£o os bin√°rios do Prometheus e do promtool, respectivamente. O diret√≥rio <code>console_libraries</code> cont√©m bibliotecas JavaScript que s√£o usadas para renderizar a interface do Prometheus. O diret√≥rio <code>consoles</code> cont√©m arquivos HTML que s√£o usados para renderizar a interface do Prometheus. O arquivo <code>prometheus.yml</code> √© o arquivo onde s√£o definidas as configura√ß√µes de scrape (coleta) de m√©tricas dos alvos a serem monitorados, regras de alerta, entre outras configura√ß√µes. Um exemplo de arquivo prometheus.yml default pode ser algo parecido com isso:</p>


  <pre><code class="language-yaml">global:
  scrape_interval: 15s

scrape_configs:
  - job_name: &#39;prometheus&#39;
    static_configs:
      - targets: [&#39;localhost:9090&#39;]</code></pre>
 <p>Nesse exemplo, temos duas se√ß√µes no arquivo de configura√ß√£o:</p>
<ul>
<li><strong>global</strong>: define as configura√ß√µes globais do Prometheus, como a frequ√™ncia de coleta de m√©tricas (scrape_interval), que neste caso √© de 15 segundos.</li>
<li><strong>scrape_configs</strong>: define as configura√ß√µes de coleta de m√©tricas para os alvos a serem monitorados. Neste caso, temos apenas um job (trabalho) definido, chamado prometheus, que monitora o pr√≥prio servidor do Prometheus na porta 9090. Para adicionar um sistema gen√©rico ao prometheus.yml, √© necess√°rio criar uma nova configura√ß√£o de scrape. Por exemplo, suponha que temos um sistema com a aplica√ß√£o web em execu√ß√£o na porta 8080. Podemos adicionar essa configura√ß√£o de scrape da seguinte forma:</li>
</ul>


  <pre><code class="language-yaml">global:
  scrape_interval: 15s

scrape_configs:
  - job_name: &#39;prometheus&#39;
    static_configs:
      - targets: [&#39;localhost:9090&#39;]

  - job_name: &#39;my-app&#39;
    static_configs:
      - targets: [&#39;my-app:8080&#39;]</code></pre>
 <p>Neste exemplo, foi criado um novo job chamado <code>my-app</code> que monitora o sistema gen√©rico na porta <code>8080</code>. O <code>static_configs</code> define os alvos a serem monitorados, que neste caso √© o sistema <code>my-app</code> na porta <code>8080</code>. Caso voc√™ deseje adicionar uma ou mais m√°quinas, recomendo que fa√ßa isso apontando para arquivos externos <code>.json</code> ao Prometheus. Para tal, podemos utilizar o mecanismo de discovery de arquivos est√°ticos. O discovery de arquivos est√°ticos permite ao Prometheus carregar dinamicamente configura√ß√µes de scrape a partir de arquivos <code>.json</code> que cont√™m informa√ß√µes sobre os alvos a serem monitorados. Por exemplo:</p>


  <pre><code class="language-yaml">global:
  scrape_interval: 15s

scrape_configs:
  - job_name: &#39;prometheus&#39;
    static_configs:
      - targets: [&#39;localhost:9090&#39;]

  - job_name: &#39;my-app&#39;
    file_sd_configs:
      - files:
        - /path/to/targets.json</code></pre>
 <p>No exemplo acima, foi criado um novo job chamado <code>my-app</code>, que usar√° o discovery de arquivos est√°ticos para buscar os alvos a serem monitorados a partir do arquivo <code>/path/to/targets.json</code>. A se√ß√£o <code>file_sd_configs</code> define as configura√ß√µes para o discovery de arquivos est√°ticos, que neste caso √© apenas o arquivo targets.json. O arquivo targets.json deve estar no seguinte formato:</p>


  <pre><code class="language-yaml">[
  {
    &#34;labels&#34;: {
      &#34;job&#34;: &#34;my-app&#34;,
      &#34;env&#34;: &#34;production&#34;
    },
    &#34;targets&#34;: [
      &#34;my-app1:8080&#34;,
      &#34;my-app2:8080&#34;
    ]
  }
]</code></pre>
 <p>Cada objeto tem uma chave labels que cont√©m um objeto com r√≥tulos adicionais para os alvos (neste exemplo, os r√≥tulos s√£o job e env), e uma chave targets que cont√©m uma lista de alvos a serem monitorados. O job my-app ter√° dois alvos a serem monitorados: my-app1:8080 e my-app2:8080. Esses alvos ter√£o os r√≥tulos job e env definidos como my-app e production, respectivamente. Al√©m da configura√ß√£o de scrape (coleta) de dados, para produ√ß√£o √© importante configurar a reten√ß√£o de dados. Para isso, adicione o par√¢metro <code>--storage.tsdb.retention.time</code> no systemd:</p>


  <pre><code class="language-bash">ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --storage.tsdb.retention.time=30d</code></pre>
 <blockquote>
<p><strong>NOTA</strong>: Para obter uma lista completa de par√¢metros, consulte a <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">documenta√ß√£o oficial do Prometheus</a>.</p></blockquote>
<blockquote>
<p><strong>Observa√ß√£o</strong>: o discovery de arquivos est√°ticos √© apenas um dos v√°rios mecanismos de descoberta dispon√≠veis no Prometheus.</p></blockquote>
<h4 id="configura√ß√µes-avan√ßadas">Configura√ß√µes Avan√ßadas</h4>
<h5 id="alerting">Alerting</h5>


  <pre><code class="language-yaml">alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
      scheme: http
      timeout: 10s
      api_version: v1</code></pre>
 <h5 id="remote-writeread">Remote Write/Read</h5>


  <pre><code class="language-yaml">remote_write:
  - url: &#34;http://remote-storage:9201/write&#34;
    remote_timeout: 30s
    write_relabel_configs:
      - source_labels: [__name__]
        regex: &#39;expensive_metric.*&#39;
        action: drop

remote_read:
  - url: &#34;http://remote-storage:9201/read&#34;
    read_timeout: 30s</code></pre>
 <h5 id="storage">Storage</h5>


  <pre><code class="language-yaml">storage:
  tsdb:
    retention.time: 15d
    retention.size: 50GB
    path: /prometheus/data
    wal:
      retention.period: 12h</code></pre>
 <h5 id="tracing-v241">Tracing (v2.41+)</h5>


  <pre><code class="language-yaml">tracing:
  endpoint: &#34;http://jaeger:14268/api/traces&#34;
  service_name: &#34;prometheus&#34;</code></pre>
 <h5 id="httptls-configuration">HTTP/TLS Configuration</h5>


  <pre><code class="language-yaml">global:
  scrape_interval: 15s
  external_url: &#39;http://prometheus.example.com&#39;

# Configura√ß√£o TLS
tls_config:
  cert_file: /path/to/cert.pem
  key_file: /path/to/key.pem
  ca_file: /path/to/ca.pem

# Configura√ß√£o OAuth2
oauth2:
  client_id: &#34;your-client-id&#34;
  client_secret: &#34;your-client-secret&#34;
  token_url: &#34;https://oauth.example.com/token&#34;</code></pre>
 <h2 id="promtool">Promtool</h2>
<p>O <a href="https://prometheus.io/docs/prometheus/latest/management_tools/promtool/">promtool</a> √© uma ferramenta de linha de comando que fornece v√°rias funcionalidades para ajudar a verificar a sintaxe de arquivos de configura√ß√£o do Prometheus, como o arquivo prometheus.yml. Para verificar a sintaxe de um arquivo de configura√ß√£o, basta executar o seguinte comando:</p>


  <pre><code class="language-bash">promtool check config /path/to/prometheus.yml</code></pre>
 <p>O promtool tamb√©m permite validar a sintaxe das regras de alerta definidas no arquivo de configura√ß√£o do Prometheus. Para isso, basta usar o seguinte comando:</p>


  <pre><code class="language-bash">promtool check rules /path/to/prometheus.yml</code></pre>
 <p>√â poss√≠vel tamb√©m validar a sintaxe dos arquivos de registro de m√©tricas antes de serem importados pelo Prometheus. Para isso, basta usar o seguinte comando:</p>


  <pre><code class="language-bash">promtool check metrics /path/to/metrics.json</code></pre>
 <p>Al√©m disso, podemos converter m√©tricas entre diferentes formatos, como JSON e texto simples. Por exemplo, para converter um arquivo de registro de m√©tricas de formato texto para formato JSON, use o seguinte comando:</p>


  <pre><code class="language-bash">$ promtool convert metrics --from=txt --to=json &lt;arquivo_de_registro_de_metricas&gt;</code></pre>
 <p>O promtool pode ser usado para validar a integridade do armazenamento de m√©tricas, ajudando a detectar problemas comuns, como blocos de registro corrompidos. Para isso, use o seguinte comando:</p>


  <pre><code class="language-bash">promtool tsdb check /path/to/data/dir</code></pre>
 <h4 id="comandos-avan√ßados-do-promtool">Comandos Avan√ßados do Promtool</h4>
<h5 id="consultas">Consultas</h5>


  <pre><code class="language-bash"># Consulta instant√¢nea
promtool query instant http://localhost:9090 &#39;up&#39;

# Consulta de intervalo
promtool query range http://localhost:9090 &#39;rate(http_requests_total[5m])&#39; --start=2023-01-01T00:00:00Z --end=2023-01-01T01:00:00Z --step=1m</code></pre>
 <h5 id="debug">Debug</h5>


  <pre><code class="language-bash"># Debug de configura√ß√£o
promtool check config --lint-fatal /path/to/prometheus.yml

# Debug de regras
promtool check rules --lint-fatal /path/to/rules.yml</code></pre>
 <h5 id="tsdb-operations">TSDB Operations</h5>


  <pre><code class="language-bash"># An√°lise do TSDB
promtool tsdb analyze /path/to/data

# Dump de blocos
promtool tsdb dump /path/to/data

# Criar blocos a partir de dados externos
promtool tsdb create-blocks-from openmetrics /path/to/metrics.txt /path/to/output</code></pre>
 <h5 id="teste-de-regras">Teste de Regras</h5>


  <pre><code class="language-bash"># Testar regras de alerta
promtool test rules /path/to/test.yml</code></pre>
 <h4 id="cen√°rios-pr√°ticos">Cen√°rios Pr√°ticos</h4>
<p><strong>1. Valida√ß√£o de Configura√ß√£o em CI/CD:</strong></p>


  <pre><code class="language-bash">#!/bin/bash
if ! promtool check config prometheus.yml; then
    echo &#34;Configura√ß√£o inv√°lida!&#34;
    exit 1
fi</code></pre>
 <p><strong>2. Debug de Problemas de Scraping:</strong></p>


  <pre><code class="language-bash"># Verificar se um target est√° acess√≠vel
promtool query instant http://localhost:9090 &#39;up{job=&#34;node-exporter&#34;}&#39;</code></pre>
 <p><strong>3. An√°lise de Performance:</strong></p>


  <pre><code class="language-bash"># Analisar uso de mem√≥ria do TSDB
promtool tsdb analyze /prometheus/data | grep &#34;memory&#34;</code></pre>
 <p>Essas s√£o apenas algumas das funcionalidades do promtool. Ele pode ser uma ferramenta muito √∫til para garantir a qualidade do seu ambiente de monitoramento com Prometheus.</p>
<h2 id="-instrumenta√ß√£o">üîç Instrumenta√ß√£o</h2>
<p>A instrumenta√ß√£o envolve coletar m√©tricas de aplica√ß√µes (instrumenta√ß√£o direta) ou sistemas externos (instrumenta√ß√£o indireta via exporters). Para detalhes completos sobre instrumenta√ß√£o, consulte a <a href="https://prometheus.io/docs/instrumenting/overview/">documenta√ß√£o oficial</a>.</p>
<h3 id="instrumenta√ß√£o-indireta">Instrumenta√ß√£o indireta</h3>
<h3 id="exporters">Exporters</h3>
<p>Exporters s√£o programas que coletam m√©tricas de sistemas externos e as convertem para o formato Prometheus. Eles permitem monitorar sistemas que n√£o exp√µem m√©tricas nativamente no formato Prometheus. Para mais informa√ß√µes sobre exporters, consulte a <a href="https://prometheus.io/docs/instrumenting/exporters/">documenta√ß√£o oficial do Prometheus</a>.</p>
<h3 id="linux">Linux</h3>
<p>O <a href="https://prometheus.io/docs/guides/node-exporter/">node_exporter</a> coleta m√©tricas do sistema operacional Linux (CPU, mem√≥ria, disco, rede). √â especialmente √∫til para monitorar hosts Linux e clusters Kubernetes.</p>
<h3 id="windows">Windows</h3>
<p>O <a href="https://github.com/prometheus-community/windows_exporter">Windows_exporter</a> √© a vers√£o Windows do node_exporter, coletando m√©tricas do sistema operacional Windows.</p>
<h3 id="blackbox">Blackbox</h3>
<p>O <a href="https://github.com/prometheus/blackbox_exporter">Blackbox Exporter</a> monitora servi√ßos externos realizando requisi√ß√µes HTTP, TCP e ICMP em endpoints espec√≠ficos.</p>
<h3 id="instrumenta√ß√£o-direta">Instrumenta√ß√£o direta</h3>
<h3 id="java">Java</h3>
<p>Use <strong><a href="https://micrometer.io/">Micrometer</a></strong> para instrumenta√ß√£o Java. Para exemplos completos e configura√ß√£o, consulte a <a href="https://prometheus.io/docs/guides/java/">documenta√ß√£o oficial</a>.</p>
<h3 id="javascriptnode">JavaScript/Node</h3>
<p>Use <strong><a href="https://github.com/siimon/prom-client">prom-client</a></strong> para instrumenta√ß√£o Node.js. Para exemplos completos e configura√ß√£o, consulte a <a href="https://prometheus.io/docs/guides/nodejs/">documenta√ß√£o oficial</a>.</p>
<h3 id="quando-usar-modo-agent-vs-modo-padr√£o">Quando usar modo Agent vs modo padr√£o</h3>
<h4 id="use-modo-agent-quando">Use modo Agent quando:</h4>
<ul>
<li>Voc√™ usa remote write para sistemas externos (Thanos, Cortex, VictoriaMetrics)</li>
<li>Precisa reduzir uso de recursos (CPU/disco)</li>
<li>N√£o precisa de consultas PromQL locais</li>
<li>Tem um sistema centralizado para alertas e consultas</li>
</ul>
<h4 id="use-modo-padr√£o-quando">Use modo padr√£o quando:</h4>
<ul>
<li>Precisa de consultas PromQL locais</li>
<li>Quer configurar alertas locais</li>
<li>Precisa de armazenamento local para an√°lise</li>
<li>Est√° fazendo testes ou desenvolvimento</li>
<li>Tem um deployment standalone</li>
</ul>
<h4 id="compara√ß√£o-de-recursos">Compara√ß√£o de recursos:</h4>
<table>
  <thead>
      <tr>
          <th>Aspecto</th>
          <th>Modo Padr√£o</th>
          <th>Modo Agent</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Armazenamento local</td>
          <td>Sim (TSDB)</td>
          <td>N√£o</td>
      </tr>
      <tr>
          <td>Consultas PromQL</td>
          <td>Sim</td>
          <td>N√£o</td>
      </tr>
      <tr>
          <td>Alertas locais</td>
          <td>Sim</td>
          <td>N√£o</td>
      </tr>
      <tr>
          <td>Uso de CPU</td>
          <td>Alto</td>
          <td>Baixo</td>
      </tr>
      <tr>
          <td>Uso de disco</td>
          <td>Alto</td>
          <td>Muito baixo</td>
      </tr>
      <tr>
          <td>Remote write</td>
          <td>Opcional</td>
          <td>Obrigat√≥rio</td>
      </tr>
  </tbody>
</table>
<h3 id="python">Python</h3>
<p>Use <strong><a href="https://github.com/prometheus/client_python">prometheus_client</a></strong> para instrumenta√ß√£o Python. Para exemplos completos e configura√ß√£o, consulte a <a href="https://prometheus.io/docs/guides/python/">documenta√ß√£o oficial</a>.</p>
<h3 id="ferramentas-legadas-e-privadas">Ferramentas legadas e privadas</h3>
<p>Para sistemas que n√£o exp√µem m√©tricas no formato Prometheus:</p>
<ul>
<li><strong>Bridge</strong>: programas intermedi√°rios que convertem m√©tricas de formatos n√£o compat√≠veis</li>
<li><strong>Plugins</strong>: extens√µes que coletam m√©tricas de ferramentas espec√≠ficas</li>
</ul>
<h2 id="alertmanager">Alertmanager</h2>
<p>O Alertmanager recebe alertas do Prometheus e os processa de acordo com regras configuradas, enviando notifica√ß√µes por email, Slack, PagerDuty, entre outros canais.</p>
<p>Para exemplos de configura√ß√£o do Alertmanager, consulte a <a href="https://prometheus.io/docs/alerting/latest/configuration/">documenta√ß√£o oficial</a>.
group_by: [&lsquo;alertname&rsquo;]
group_wait: 30s
group_interval: 5m
repeat_interval: 1h
receiver: &lsquo;slack-notifications&rsquo;</p>
<p>receivers:</p>
<ul>
<li>name: &lsquo;slack-notifications&rsquo;
slack_configs:
<ul>
<li>api_url: &lsquo;<a href="https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX%27">https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX'</a>
channel: &lsquo;#alerts&rsquo;
send_resolved: true
title: &ldquo;{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}&rdquo;
text: &ldquo;{{ range .Alerts }}{{ .Annotations.description }}\n{{ end }}&rdquo;</li>
</ul>
</li>
</ul>


  <pre><code class="language-">
Para configurar o Alertmanager com o Prometheus, √© necess√°rio criar um arquivo de configura√ß√£o `alertmanager.yml` e especificar o endpoint do Alertmanager no arquivo de configura√ß√£o `prometheus.yml`. O arquivo `alertmanager.yml` cont√©m as regras de roteamento de alertas e configura√ß√µes de notifica√ß√£o, como os destinat√°rios e as plataformas de notifica√ß√£o. Para mais informa√ß√µes sobre como configurar o Alertmanager, consulte a documenta√ß√£o oficial em https://prometheus.io/docs/alerting/latest/configuration/.

&gt; **Observa√ß√£o**: o Alertmanager n√£o √© um componente obrigat√≥rio do Prometheus. Ele √© uma ferramenta opcional que pode ser usada para gerenciar alertas. Se voc√™ n√£o precisar de alertas, n√£o precisa configurar o Alertmanager. Pretendo escrever um outro artigo dedicado ao Alertmanager, ent√£o fique ligado!

## PushGateway

PushGateway √© um componente adicional do Prometheus projetado especificamente para **jobs de curta dura√ß√£o** que n√£o podem ser monitorados diretamente pelo modelo pull do Prometheus. Ele funciona como uma &#34;ponte&#34; que recebe dados enviados pelos aplicativos e os repassa para o Prometheus Server.

### Casos de uso apropriados

O PushGateway √© √∫til para:

- **Scripts e tarefas cron**: Jobs que executam por alguns minutos e terminam
- **Jobs de batch**: Processos que rodam periodicamente e terminam
- **Tarefas de manuten√ß√£o**: Scripts de backup, limpeza, etc.
- **Jobs de CI/CD**: Builds, testes, deployments que t√™m dura√ß√£o limitada

### ‚ö†Ô∏è IMPORTANTE: N√£o use para servi√ßos long-running

**O PushGateway N√ÉO deve ser usado para:**

- Servi√ßos web que rodam continuamente
- Aplica√ß√µes de longa dura√ß√£o
- Microservi√ßos
- Qualquer servi√ßo que possa ser monitorado diretamente pelo Prometheus

### Por que n√£o usar para servi√ßos long-running?

1. **Perda de dados**: O PushGateway n√£o armazena dados persistentemente
2. **Sem alertas**: N√£o suporta funcionalidade de alertas do Prometheus
3. **Complexidade desnecess√°ria**: Adiciona uma camada extra sem benef√≠cios
4. **Problemas de escalabilidade**: Pode se tornar um gargalo
5. **Dificuldade de troubleshooting**: Mais dif√≠cil de debugar problemas

### Exemplo de uso correto

```bash
# Script que executa e termina
#!/bin/bash
# ... l√≥gica do script ...

# Enviar m√©tricas para PushGateway
echo &#34;my_job_duration_seconds 45.2&#34; | curl --data-binary @- http://pushgateway:9091/metrics/job/my_batch_job

# Script termina</code></pre>
 <h3 id="configura√ß√£o-no-prometheus">Configura√ß√£o no Prometheus</h3>


  <pre><code class="language-yaml">scrape_configs:
  - job_name: &#39;pushgateway&#39;
    honor_labels: true
    static_configs:
      - targets: [&#39;pushgateway:9091&#39;]</code></pre>
 <p>O PushGateway √© uma ferramenta especializada para casos espec√≠ficos. Para a maioria dos casos de uso, use instrumenta√ß√£o direta ou exporters.</p>
<h2 id="federa√ß√£o">Federa√ß√£o</h2>
<p>A Federa√ß√£o no Prometheus √© um recurso que permite que v√°rias inst√¢ncias do Prometheus sejam agrupadas e gerenciadas como uma √∫nica inst√¢ncia. Isso √© √∫til quando voc√™ tem v√°rios sistemas ou aplicativos que precisam ser monitorados, mas quer gerenciar esses dados de m√©tricas de forma centralizada. A Federa√ß√£o funciona criando uma hierarquia de inst√¢ncias do Prometheus, onde cada inst√¢ncia √© chamada de &ldquo;federada&rdquo; ou &ldquo;filha&rdquo; e uma inst√¢ncia √© chamada de &ldquo;federadora&rdquo; ou &ldquo;pai&rdquo;. A inst√¢ncia &ldquo;federadora&rdquo; √© respons√°vel por coletar dados de m√©tricas de todas as inst√¢ncias &ldquo;federadas&rdquo; e agrup√°-los em um √∫nico local. No entanto, em alguns casos, o uso da Federa√ß√£o pode causar problemas. Abaixo uma melhor explica√ß√£o sobre estes pontos:</p>
<ul>
<li><strong>Grande volume de dados</strong>: Se voc√™ estiver lidando com um grande volume de dados, a Federa√ß√£o pode sobrecarregar a inst√¢ncia central do Prometheus, j√° que todas as m√©tricas s√£o coletadas de v√°rias inst√¢ncias e armazenadas na inst√¢ncia central. Isso pode levar a problemas de desempenho e lat√™ncia.</li>
<li><strong>Aumento da complexidade</strong>: A configura√ß√£o e manuten√ß√£o de uma estrutura federada pode ser complexa, especialmente se voc√™ tiver v√°rias inst√¢ncias do Prometheus e hierarquias diferentes. Isso pode tornar a solu√ß√£o dif√≠cil de gerenciar e manter, aumentando a chance de erros e problemas de configura√ß√£o.</li>
<li><strong>Depend√™ncia de rede</strong>: A Federa√ß√£o exige uma conex√£o de rede est√°vel e confi√°vel entre as inst√¢ncias do Prometheus. Se a rede entre as inst√¢ncias for inst√°vel ou lenta, a coleta e consolida√ß√£o das m√©tricas pode ser afetada, causando atrasos ou perda de dados.</li>
<li><strong>Escalabilidade limitada</strong>: A Federa√ß√£o pode n√£o ser a melhor op√ß√£o para ambientes de grande escala, com muitos servi√ßos e inst√¢ncias do Prometheus. Nesse cen√°rio, a inst√¢ncia central pode se tornar um gargalo e limitar a escalabilidade geral do sistema de monitoramento.</li>
<li><strong>Seguran√ßa</strong>: A Federa√ß√£o requer que as inst√¢ncias do Prometheus se comuniquem entre si e compartilhem dados. Isso pode aumentar a superf√≠cie de ataque e potencialmente expor informa√ß√µes sens√≠veis, caso as medidas adequadas de seguran√ßa n√£o sejam implementadas.</li>
</ul>
<blockquote>
<p><strong>NOTA</strong>: Em um outro artigo pretendo escrever sobre como resolver o problema de federa√ß√£o potencializando o Prometheus com outras t√©cnologias, fique ligado!</p></blockquote>
<h2 id="under-the-hood">Under the Hood</h2>
<p>A pasta raiz do Prometheus cont√©m v√°rios arquivos de configura√ß√£o e dados. Os arquivos mais comuns incluem:</p>
<ul>
<li><strong>prometheus.yml:</strong> Este √© o arquivo de configura√ß√£o principal do Prometheus. Ele cont√©m configura√ß√µes como endere√ßos de coleta de dados, regras de alerta e configura√ß√µes de armazenamento.</li>
<li><strong>alert.rules:</strong> Este arquivo cont√©m regras de alerta que o Prometheus usa para gerar alertas quando as m√©tricas atenderem a certas condi√ß√µes.</li>
<li><strong>scrape_configs:</strong> Este arquivo cont√©m configura√ß√µes de coleta de dados que o Prometheus usa para coletar m√©tricas de diferentes fontes.</li>
<li><strong>rules.yml:</strong> Este arquivo cont√©m as regras de processamento de m√©tricas do Prometheus. Ele especifica como o Prometheus deve processar as m√©tricas coletadas.</li>
<li><strong>data:</strong> Esta pasta cont√©m os dados de m√©tricas coletadas pelo Prometheus. Isso inclui arquivos como o banco de dados de m√©tricas e arquivos de registro.</li>
</ul>
<p>Al√©m desses arquivos, a pasta raiz do Prometheus tamb√©m pode conter outros arquivos de configura√ß√£o e dados, dependendo da configura√ß√£o do Prometheus.  A pasta <strong>/data</strong> no Prometheus √© usada para armazenar todos os dados coletados pelo Prometheus. Ela cont√©m v√°rias pastas, como <strong>WAL, chunks_head,</strong> que s√£o usadas para armazenar diferentes tipos de dados. Exemplo:</p>


  <pre><code class="language-bash">./data
‚îú‚îÄ‚îÄ 01BKGV7JBM69T2G1BGBGM6KB12
‚îÇ   ‚îî‚îÄ‚îÄ meta.json
‚îú‚îÄ‚îÄ 01BKGTZQ1SYQJTR4PB43C8PD98
‚îÇ   ‚îú‚îÄ‚îÄ chunks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 000001
‚îÇ   ‚îú‚îÄ‚îÄ tombstones
‚îÇ   ‚îú‚îÄ‚îÄ index
‚îÇ   ‚îî‚îÄ‚îÄ meta.json
‚îú‚îÄ‚îÄ 01BKGTZQ1HHWHV8FBJXW1Y3W0K
‚îÇ   ‚îî‚îÄ‚îÄ meta.json
‚îú‚îÄ‚îÄ 01BKGV7JC0RY8A6MACW02A2PJD
‚îÇ   ‚îú‚îÄ‚îÄ chunks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 000001
‚îÇ   ‚îú‚îÄ‚îÄ tombstones
‚îÇ   ‚îú‚îÄ‚îÄ index
‚îÇ   ‚îî‚îÄ‚îÄ meta.json
‚îú‚îÄ‚îÄ chunks_head
‚îÇ   ‚îî‚îÄ‚îÄ 000001
‚îî‚îÄ‚îÄ wal
    ‚îú‚îÄ‚îÄ 000000002
    ‚îî‚îÄ‚îÄ checkpoint.00000001
        ‚îî‚îÄ‚îÄ 00000000</code></pre>
 <p>O arquivo meta.json √© usado para armazenar metadados dos s√©ries de dados que o Prometheus est√° rastreando. Ele cont√©m informa√ß√µes como o nome do arquivo e o intervalo de tempo dos dados armazenados, bem como outras informa√ß√µes relevantes para o funcionamento interno do Prometheus. Os itens espec√≠ficos dentro do arquivo meta.json podem variar dependendo da configura√ß√£o espec√≠fica do Prometheus e do tipo de s√©rie de dados que est√° sendo rastreada. Vamos aos detalhes:</p>


  <pre><code class="language-bash">{
    &#34;ulid&#34;: &#34;01BKGTZQ1SYQJTR4PB43C8PD98&#34;,
    &#34;minTime&#34;: 1602237600000,
    &#34;maxTime&#34;: 1602244800000,
    &#34;stats&#34;: {
        &#34;numSamples&#34;: 553673232,
        &#34;numSeries&#34;: 1346066,
        &#34;numChunks&#34;: 4440437
    },
    &#34;compaction&#34;: {
        &#34;level&#34;: 1,
        &#34;sources&#34;: [
            &#34;01EM65SHSX4VARXBBHBF0M0FDS&#34;,
            &#34;01EM6GAJSYWSQQRDY782EA5ZPN&#34;
        ]
    },
    &#34;version&#34;: 1
}</code></pre>
 <ul>
<li><strong>ulid:</strong> √© um identificador √∫nico gerado para cada arquivo meta.json. √â usado para identificar de forma √∫nica cada s√©rie de dados armazenada pelo Prometheus.</li>
<li><strong>minTime e maxTime:</strong> s√£o os intervalos de tempo de in√≠cio e fim dos dados armazenados no arquivo meta.json. Eles s√£o usados para determinar o per√≠odo de tempo para o qual os dados armazenados no arquivo s√£o v√°lidos.</li>
<li><strong>stats:</strong> √© um objeto que cont√©m estat√≠sticas sobre o uso de mem√≥ria do arquivo meta.json, incluindo o tamanho do arquivo, o n√∫mero de s√©ries de dados armazenadas e o n√∫mero de amostras de dados.</li>
<li><strong>numSamples:</strong> √© o n√∫mero de amostras de dados armazenadas no arquivo meta.json.</li>
<li><strong>numSeries:</strong> √© o n√∫mero de s√©ries de dados armazenadas no arquivo meta.json.</li>
<li><strong>numChunks:</strong> √© o n√∫mero de chunks de dados (grupos de amostras de dados) armazenados no arquivo meta.json.</li>
<li><strong>compaction:</strong> √© um objeto que cont√©m informa√ß√µes sobre a compacta√ß√£o dos dados armazenados no arquivo meta.json.</li>
<li><strong>level:</strong> √© o n√≠vel de compacta√ß√£o dos dados armazenados no arquivo meta.json.</li>
<li><strong>sources:</strong> √© um array que cont√©m informa√ß√µes sobre as fontes dos dados armazenados no arquivo meta.json.</li>
<li><strong>version:</strong> √© a vers√£o do arquivo meta.json. √â usado para garantir compatibilidade com vers√µes futuras do Prometheus.</li>
</ul>
<p>A pasta &ldquo;chunks&rdquo; dentro da pasta 01BKGTZQ1SYQJTR4PB43C8PD98 dentro do diret√≥rio /data do Prometheus √© usada para armazenar os chunks de dados (grupos de amostras de dados) para cada s√©rie de dados que o Prometheus est√° rastreando. Cada arquivo dentro dessa pasta representa um chunk de dados √∫nico, e o nome do arquivo cont√©m informa√ß√µes sobre o intervalo de tempo e a s√©rie de dados a qual ele pertence. Os arquivos de chunks s√£o gerados pelo processo de compacta√ß√£o do Prometheus. Eles s√£o criados quando o Prometheus precisa remover dados antigos para liberar espa√ßo e continuar coletando novos dados.</p>
<p>Esses chunks s√£o usados para a recupera√ß√£o dos dados e para realizar consultas no futuro. Os arquivos contidos dentro dessa pasta s√£o codificados e compactados de forma a ocupar menos espa√ßo e s√£o lidos pelo Prometheus para responder consultas e exibir gr√°ficos. J√° o arquivo index, cont√©m o √≠ndice dos chunks de dados armazenados na pasta &ldquo;chunks&rdquo; da mesma pasta. O √≠ndice √© usado para permitir que o Prometheus r√°pida e eficientemente localize os chunks de dados relevantes para uma consulta espec√≠fica. Esse arquivo cont√©m informa√ß√µes sobre as s√©ries de dados, o intervalo de tempo dos dados, o nome do arquivo de chunk correspondente, e outras informa√ß√µes relevantes. O Prometheus usa essas informa√ß√µes para saber onde procurar os dados quando uma consulta √© realizada, permitindo que ele responda rapidamente.</p>
<h3 id="gerenciamento-de-mem√≥ria-pelo-prometheus">Gerenciamento de mem√≥ria pelo Prometheus</h3>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-mem01.png" alt="img">
<small style="text-align:center;"><b>Imagem 1.1</b></small></p>
<p>A imagem 1.1 acima representa o Prometheus quando usa mem√≥ria RAM e espa√ßo em disco devido √† natureza dos dados que ele coleta e armazena.</p>
<h4 id="head-block">Head Block</h4>
<p>O head block √© a parte mais recente dos dados do Prometheus que fica em mem√≥ria. Por padr√£o, ele cont√©m dados das √∫ltimas duas horas e consome aproximadamente 3 kB por s√©rie temporal. O head block √© otimizado para:</p>
<ul>
<li><strong>Consultas r√°pidas</strong>: Dados em mem√≥ria permitem acesso imediato</li>
<li><strong>Escrita eficiente</strong>: Novos dados s√£o escritos diretamente no head block</li>
<li><strong>Compacta√ß√£o</strong>: Quando o head block atinge o limite de tempo, ele √© compactado e movido para o disco</li>
</ul>
<p>O tamanho do head block pode ser configurado atrav√©s do par√¢metro <code>--storage.tsdb.min-block-duration</code> e <code>--storage.tsdb.max-block-duration</code>.</p>
<h4 id="write-ahead-log-wal">Write-Ahead Log (WAL)</h4>
<p>O WAL √© um mecanismo de persist√™ncia que garante que nenhum dado seja perdido, mesmo em caso de falha do sistema. Funciona da seguinte forma:</p>
<ul>
<li><strong>Grava√ß√£o imediata</strong>: Todas as mudan√ßas s√£o gravadas no WAL antes de serem aplicadas em mem√≥ria</li>
<li><strong>Recupera√ß√£o</strong>: Em caso de falha, o Prometheus pode recuperar dados do WAL</li>
<li><strong>Compacta√ß√£o autom√°tica</strong>: O WAL √© periodicamente compactado e os dados s√£o movidos para blocos permanentes</li>
<li><strong>Sem depend√™ncia do swap</strong>: O Prometheus n√£o usa swap do sistema operacional; o WAL √© gravado diretamente em disco</li>
</ul>
<p>O WAL √© armazenado no diret√≥rio <code>wal/</code> dentro do diret√≥rio de dados do Prometheus e √© gerenciado automaticamente pelo sistema.</p>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-mem02.png" alt="img">
<small style="text-align:center;"><b>Imagem 1.2</b></small></p>
<p>Como bem mostra a Imagem 1.2 acima, quanto mais dias de dados s√£o armazenados, mais espa√ßo em disco ser√° necess√°rio para armazen√°-los.</p>
<p><img src="https://raw.githubusercontent.com/scovl/scovl.github.io/main/post/images/tsdb/prom-mem03.png" alt="img">
<small style="text-align:center;"><b>Imagem 1.3</b></small></p>
<p>Como mostra na Imagem 1.3 acima, o Prometheus utiliza a mem√≥ria principal do host Linux para armazenar apenas o &ldquo;head block&rdquo; (dados das √∫ltimas duas horas por padr√£o) e metadados das m√©tricas coletadas. O Prometheus mant√©m aproximadamente 3 kB por s√©rie temporal em mem√≥ria para o head block, que cont√©m os dados mais recentes para consultas r√°pidas.</p>
<h2 id="promql">PromQL</h2>
<p>PromQL √© uma linguagem de consulta poderosa usada para realizar consultas e configurar alertas sobre dados coletados pelo Prometheus. Seu principal objetivo √© possibilitar a an√°lise e monitoramento de m√©tricas, como requisi√ß√µes HTTP por segundo ou a m√©dia de utiliza√ß√£o de CPU por servidor, por meio de express√µes que definem c√°lculos espec√≠ficos. Importante para os usu√°rios do Prometheus, a PromQL suporta fun√ß√µes matem√°ticas, opera√ß√µes booleanas e de compara√ß√£o, al√©m de agrupamento de dados e agrega√ß√µes. Al√©m disso, conta com recursos avan√ßados como subconsultas e fun√ß√µes de s√©ries temporais. As consultas PromQL podem ser executadas atrav√©s da interface web do Prometheus, APIs ou bibliotecas de clientes.</p>
<p>A linguagem tamb√©m possibilita a cria√ß√£o de gr√°ficos e pain√©is de visualiza√ß√£o para m√©tricas, utilizando ferramentas de visualiza√ß√£o de dados como o Grafana. Dessa forma, a PromQL se mostra essencial para monitorar e analisar o desempenho de sistemas com efici√™ncia e precis√£o.</p>
<h3 id="time-series-database">Time series database</h3>
<p>O Prometheus armazena dados em um formato bin√°rio chamado TSDB (Time Series Database). O TSDB √© um banco de dados de s√©ries temporais otimizado para armazenar dados de m√©tricas. Para simplificar o entendimento acerca de um banco de dados de s√©rie temporal, imagine que voc√™ tem um di√°rio onde voc√™ registra a temperatura do ar todos os dias, √†s mesmas horas, assim como a velocidade do vento, press√£o atmosf√©rica, entre outras informa√ß√µes. Essas informa√ß√µes s√£o armazenadas em ordem cronol√≥gica, ou seja, por ordem de tempo, e √© poss√≠vel consult√°-las para ver como esses dados variam ao longo do tempo.</p>
<p>Monitorar m√©tricas a partir de um banco de dados em s√©rie temporal tem v√°rias vantagens:</p>
<ul>
<li><strong>An√°lise hist√≥rica:</strong> Um banco de dados em s√©rie temporal armazena dados em ordem cronol√≥gica, o que permite a an√°lise de tend√™ncias e padr√µes ao longo do tempo.</li>
<li><strong>Identifica√ß√£o de problemas:</strong> Armazenando dados em ordem cronol√≥gica, √© poss√≠vel investigar problemas usando dados hist√≥ricos.</li>
<li><strong>Alertas baseados no tempo:</strong> Com dados armazenados em ordem cronol√≥gica, √© poss√≠vel criar alertas baseados no tempo.</li>
<li><strong>Armazenamento escal√°vel:</strong> Banco de dados em s√©rie temporal s√£o projetados para lidar com grandes volumes de dados e escalar horizontalmente.</li>
<li><strong>Integra√ß√£o com outras ferramentas:</strong> A maioria das ferramentas de monitoramento e an√°lise de dados suportam a coleta de dados de banco de dados em s√©rie temporal.</li>
</ul>
<h3 id="seletores">Seletores</h3>
<p>Os seletores em PromQL s√£o como filtros que permitem escolher uma ou mais m√©tricas espec√≠ficas para consultas. Existem dois tipos de seletores: o primeiro √© o seletor de nome de m√©trica, que seleciona m√©tricas pelo seu nome, como por exemplo <code>http_requests_total</code>. O segundo √© o seletor de label, que seleciona m√©tricas pelo label associado a elas.</p>
<p>Exemplo:</p>


  <pre><code class="language-bash">http_requests_total{method=&#34;GET&#34;, handler=&#34;/api/v1/users&#34;}</code></pre>
 <ul>
<li>Selecionando todas as m√©tricas que possuem &ldquo;http&rdquo; no nome:</li>
</ul>


  <pre><code class="language-bash">{__name__=~&#34;http.*&#34;}</code></pre>
 <ul>
<li>Selecionando m√©tricas que possuem o label &ldquo;status&rdquo; com o valor &ldquo;error&rdquo;:</li>
</ul>


  <pre><code class="language-bash">{status=&#34;error&#34;}</code></pre>
 <h3 id="tipos-de-express√µes">Tipos de express√µes</h3>
<p>Em PromQL, existem v√°rios tipos de express√µes que podem ser usadas para manipular as m√©tricas coletadas pelo Prometheus:</p>
<ul>
<li><strong>Express√µes aritm√©ticas:</strong> s√£o usadas para realizar c√°lculos matem√°ticos em s√©ries de m√©tricas. Por exemplo:</li>
</ul>


  <pre><code class="language-bash">node_cpu_seconds_total{mode=&#34;system&#34;} / node_cpu_seconds_total{mode=&#34;idle&#34;} * 100</code></pre>
 <ul>
<li><strong>Fun√ß√µes de agrega√ß√£o:</strong> s√£o usadas para agrupar e resumir s√©ries de m√©tricas. Exemplo:</li>
</ul>


  <pre><code class="language-bash">sum(rate(http_requests_total[5m])) by (job)</code></pre>
 <ul>
<li><strong>Fun√ß√µes de filtro:</strong> s√£o usadas para filtrar s√©ries de m√©tricas com base em seus labels. Exemplo:</li>
</ul>


  <pre><code class="language-bash">topk(5, http_requests_total)</code></pre>
 <ul>
<li><strong>Fun√ß√µes de transforma√ß√£o:</strong> s√£o usadas para transformar s√©ries de m√©tricas de uma maneira espec√≠fica. Exemplo:</li>
</ul>


  <pre><code class="language-bash">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</code></pre>
 <h3 id="vector-vs-range-vector">Vector vs Range Vector</h3>
<p>Em PromQL, h√° dois tipos principais de vetores que podemos usar em nossas consultas:</p>
<ul>
<li>
<p><strong>Vetor:</strong> √â um conjunto de pontos de dados com os mesmos labels, representando a s√©rie temporal de uma √∫nica m√©trica. Por exemplo, o vetor <code>up{job=&quot;prometheus&quot;}</code> representa o tempo em que o servi√ßo Prometheus estava em execu√ß√£o ou n√£o.</p>
</li>
<li>
<p><strong>Range Vector:</strong> √â um conjunto de pontos de dados com os mesmos labels, mas que representa um intervalo de tempo em vez de um √∫nico ponto no tempo. Exemplo: <code>up{job=&quot;prometheus&quot;}[5m]</code> representa o tempo em que o servi√ßo Prometheus estava em execu√ß√£o ou n√£o nos √∫ltimos 5 minutos.</p>
</li>
</ul>
<h3 id="fun√ß√µes-principais">Fun√ß√µes principais</h3>
<h4 id="fun√ß√µes-de-agrega√ß√£o">Fun√ß√µes de agrega√ß√£o</h4>
<ul>
<li><strong>sum():</strong> Soma os valores de uma s√©rie temporal</li>
<li><strong>avg():</strong> Calcula a m√©dia dos valores</li>
<li><strong>min():</strong> Retorna o valor m√≠nimo</li>
<li><strong>max():</strong> Retorna o valor m√°ximo</li>
<li><strong>count():</strong> Conta o n√∫mero de s√©ries temporais</li>
</ul>
<h4 id="fun√ß√µes-de-taxa">Fun√ß√µes de taxa</h4>
<ul>
<li><strong>rate():</strong> Calcula a taxa de varia√ß√£o por segundo ao longo de um intervalo de tempo</li>
<li><strong>irate():</strong> Calcula a taxa instant√¢nea de varia√ß√£o</li>
<li><strong>increase():</strong> Calcula o incremento total do contador em um intervalo de tempo (soma todas as mudan√ßas)</li>
</ul>
<blockquote>
<p><strong>Diferen√ßa importante</strong>: <code>rate()</code> retorna a taxa por segundo (ex: 10 req/s), enquanto <code>increase()</code> retorna o total absoluto (ex: 600 requisi√ß√µes nos √∫ltimos 60s). <code>increase()</code> √© essencialmente <code>rate() * intervalo_de_tempo</code>.</p></blockquote>
<h4 id="fun√ß√µes-de-tempo">Fun√ß√µes de tempo</h4>
<ul>
<li><strong>time():</strong> Retorna o timestamp atual</li>
<li><strong>timestamp():</strong> Retorna o timestamp de uma s√©rie temporal</li>
</ul>
<h3 id="exemplos-pr√°ticos">Exemplos pr√°ticos</h3>
<h4 id="cpu-usage">CPU Usage</h4>
<ul>
<li>Uso m√©dio da CPU nos √∫ltimos 5 minutos:</li>
</ul>


  <pre><code class="language-bash">avg(rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) * 100</code></pre>
 <ul>
<li>Uso da CPU por processo:</li>
</ul>


  <pre><code class="language-bash">100 - avg by (process) (irate(process_cpu_seconds_total{process!=&#34;prometheus&#34;}[5m])) * 100</code></pre>
 <h4 id="mem√≥ria">Mem√≥ria</h4>
<ul>
<li>Porcentagem de mem√≥ria usada:</li>
</ul>


  <pre><code class="language-bash">100 - ((node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100)</code></pre>
 <h4 id="http-requests">HTTP Requests</h4>
<ul>
<li>Taxa de requisi√ß√µes HTTP por segundo:</li>
</ul>


  <pre><code class="language-bash">rate(http_requests_total[5m])</code></pre>
 <ul>
<li>Total de requisi√ß√µes HTTP nos √∫ltimos 5 minutos:</li>
</ul>


  <pre><code class="language-bash">increase(http_requests_total[5m])</code></pre>
 <ul>
<li>Taxa de erros HTTP (c√≥digos 5xx):</li>
</ul>


  <pre><code class="language-bash">rate(http_requests_total{status=~&#34;5..&#34;}[5m])</code></pre>
 <ul>
<li>Total de erros HTTP nos √∫ltimos 5 minutos:</li>
</ul>


  <pre><code class="language-bash">increase(http_requests_total{status=~&#34;5..&#34;}[5m])</code></pre>
 <h3 id="erros-comuns">Erros comuns</h3>
<ul>
<li><strong>Cardinalidade alta:</strong> Usar labels com valores n√£o-limitados pode sobrecarregar o Prometheus. Exemplo problem√°tico:</li>
</ul>


  <pre><code class="language-bash">rate(http_requests_total{user_id!=&#34;&#34;}[5m])</code></pre>
 <p><strong>Solu√ß√£o:</strong> Use labels com valores categorizados e limitados:</p>


  <pre><code class="language-bash">rate(http_requests_total{status=~&#34;2..|3..|4..|5..&#34;}[5m])</code></pre>
 <ul>
<li><strong>Granularidade desnecess√°ria:</strong> Selecionar uma granularidade muito alta pode gerar muitos dados. Exemplo problem√°tico:</li>
</ul>


  <pre><code class="language-bash">rate(http_requests_total[1s])</code></pre>
 <ul>
<li><strong>Ignorar fun√ß√µes de agrega√ß√£o:</strong> Esquecer de usar fun√ß√µes de agrega√ß√£o pode resultar em gr√°ficos confusos.</li>
</ul>
<blockquote>
<p><strong>Observa√ß√£o</strong>: A dica de ouro √© que se voc√™ est√° tendo problema de desempenho em trazer m√©tricas, provavelmente h√° algo errado com a sua query.</p></blockquote>
<h2 id="melhores-pr√°ticas">Melhores Pr√°ticas</h2>
<p>Ap√≥s entendermos a arquitetura interna do Prometheus e como ele gerencia dados, √© importante discutir algumas melhores pr√°ticas que podem otimizar seu uso e evitar problemas comuns:</p>
<h3 id="planejamento-de-capacidade">Planejamento de Capacidade</h3>
<ul>
<li><strong>Dimensionamento adequado</strong>: Planeje o dimensionamento do servidor Prometheus com base no n√∫mero de m√©tricas a serem coletadas, frequ√™ncia de coleta e per√≠odo de reten√ß√£o.</li>
<li><strong>Monitoramento do pr√≥prio Prometheus</strong>: Utilize m√©tricas como <code>prometheus_tsdb_head_series</code> e <code>prometheus_engine_queries</code> para monitorar a sa√∫de da pr√≥pria inst√¢ncia.</li>
<li><strong>Pol√≠tica de reten√ß√£o</strong>: Defina uma pol√≠tica de reten√ß√£o realista (via <code>--storage.tsdb.retention.time</code> ou <code>--storage.tsdb.retention.size</code>) baseada nas necessidades reais de an√°lise hist√≥rica.</li>
</ul>
<h3 id="organiza√ß√£o-de-m√©tricas">Organiza√ß√£o de M√©tricas</h3>
<ul>
<li><strong>Nomea√ß√£o consistente</strong>: Adote um padr√£o de nomenclatura para suas m√©tricas usando snake_case e prefixos de aplica√ß√£o (<code>app_http_requests_total</code>).</li>
<li><strong>Labels significativos</strong>: Use labels para adicionar dimens√µes √†s m√©tricas, mas evite valores n√£o-limitados.</li>
<li><strong>Evite explos√£o de cardinalidade</strong>: Nunca use valores de alta cardinalidade como IDs de usu√°rio, URLs completos ou timestamps como labels. Prefira valores categorizados e limitados.</li>
</ul>
<h3 id="cardinalidade">Cardinalidade</h3>
<p>A cardinalidade refere-se ao n√∫mero de s√©ries temporais √∫nicas criadas por suas m√©tricas. Alta cardinalidade pode causar problemas de performance e consumo de mem√≥ria.</p>
<h4 id="-valores-problem√°ticos-alta-cardinalidade">‚ùå Valores problem√°ticos (alta cardinalidade):</h4>
<ul>
<li>IDs de usu√°rio: <code>user_id=&quot;12345&quot;</code></li>
<li>URLs completos: <code>url=&quot;/api/users/12345/posts/67890/comments&quot;</code></li>
<li>Timestamps: <code>timestamp=&quot;2023-03-21T15:30:45Z&quot;</code></li>
<li>IPs din√¢micos: <code>ip=&quot;192.168.1.100&quot;</code></li>
</ul>
<h4 id="-valores-recomendados-cardinalidade-controlada">‚úÖ Valores recomendados (cardinalidade controlada):</h4>
<ul>
<li>Status codes: <code>status=&quot;200&quot;</code>, <code>status=&quot;404&quot;</code>, <code>status=&quot;500&quot;</code></li>
<li>M√©todos HTTP: <code>method=&quot;GET&quot;</code>, <code>method=&quot;POST&quot;</code></li>
<li>Endpoints categorizados: <code>endpoint=&quot;/api/users&quot;</code>, <code>endpoint=&quot;/api/posts&quot;</code></li>
<li>Regi√µes: <code>region=&quot;us-east-1&quot;</code>, <code>region=&quot;eu-west-1&quot;</code></li>
<li>Ambientes: <code>env=&quot;production&quot;</code>, <code>env=&quot;staging&quot;</code></li>
</ul>
<h4 id="princ√≠pio-use-valores-que-voc√™-pode-listar">Princ√≠pio: Use valores que voc√™ pode listar</h4>
<p>Se voc√™ n√£o consegue listar todos os valores poss√≠veis de uma label, ela provavelmente tem cardinalidade muito alta.</p>
<h3 id="consultas-eficientes">Consultas Eficientes</h3>
<ul>
<li><strong>Limite o uso de fun√ß√µes pesadas</strong>: Fun√ß√µes como <code>topk()</code>, <code>bottomk()</code> e agrega√ß√µes com <code>by</code> em muitas dimens√µes podem ser caras.</li>
<li><strong>Prefira <code>rate()</code> sobre <code>irate()</code></strong>: Para a maioria dos dashboards, <code>rate()</code> oferece uma vis√£o mais est√°vel da taxa de mudan√ßa de uma m√©trica.</li>
<li><strong>Use intervalos de tempo razo√°veis</strong>: Consultas sobre per√≠odos muito longos consomem mais recursos; limite-as quando poss√≠vel.</li>
</ul>
<h3 id="arquitetura-para-escala">Arquitetura para Escala</h3>
<ul>
<li><strong>Adote Prometheus hier√°rquico</strong>: Para ambientes grandes, considere uma arquitetura hier√°rquica com federa√ß√£o para dividir a carga.</li>
<li><strong>Considere solu√ß√µes de longo prazo</strong>: Para reten√ß√£o de longo prazo e alta disponibilidade, explore solu√ß√µes como Thanos, Cortex ou VictoriaMetrics.</li>
<li><strong>Sharding</strong>: Em ambientes muito grandes, divida o trabalho de scraping entre m√∫ltiplas inst√¢ncias do Prometheus.</li>
</ul>
<h3 id="seguran√ßa">Seguran√ßa</h3>
<ul>
<li><strong>Controle de acesso</strong>: Implemente autentica√ß√£o e autoriza√ß√£o para acesso √† API do Prometheus.</li>
<li><strong>TLS para endpoints</strong>: Habilite TLS para comunica√ß√µes entre Prometheus e seus alvos quando poss√≠vel.</li>
<li><strong>Isolamento de rede</strong>: Restrinja o acesso ao Prometheus apenas a redes confi√°veis ou use um proxy reverso com autentica√ß√£o.</li>
</ul>
<p>A implementa√ß√£o dessas pr√°ticas n√£o apenas melhorar√° o desempenho do seu ambiente Prometheus, mas tamb√©m facilitar√° sua manuten√ß√£o e crescimento ao longo do tempo.</p>
<h2 id="recursos-modernos-do-prometheus">Recursos Modernos do Prometheus</h2>
<h3 id="native-histogram-beta--v240">Native Histogram (Beta ‚â• v2.40)</h3>
<p>O Prometheus introduziu native histograms como uma alternativa mais eficiente aos histogramas tradicionais. Native histograms reduzem significativamente a cardinalidade para m√©tricas de lat√™ncia, oferecendo melhor performance e menor uso de mem√≥ria.</p>
<h4 id="vantagens-dos-native-histograms">Vantagens dos Native Histograms:</h4>
<ul>
<li><strong>Menor cardinalidade</strong>: N√£o criam m√∫ltiplas s√©ries por bucket</li>
<li><strong>Melhor performance</strong>: Consultas mais r√°pidas</li>
<li><strong>Flexibilidade</strong>: Buckets din√¢micos baseados na distribui√ß√£o real dos dados</li>
<li><strong>Compatibilidade</strong>: Funciona com ferramentas existentes</li>
</ul>
<h4 id="exemplo-de-configura√ß√£o">Exemplo de configura√ß√£o:</h4>


  <pre><code class="language-yaml"># Em prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: &#39;my-app&#39;
    static_configs:
      - targets: [&#39;my-app:8080&#39;]
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: &#39;http_request_duration_seconds&#39;
        action: replace
        target_label: __name__
        replacement: &#39;http_request_duration_seconds_native&#39;</code></pre>
 <h3 id="vertical-sharding-experimental-v251">Vertical Sharding Experimental (v2.51+)</h3>
<p>O Prometheus 2.51 introduziu vertical sharding experimental, permitindo distribuir a carga de scraping entre m√∫ltiplas inst√¢ncias do Prometheus.</p>
<h3 id="ecossistema-atualizado">Ecossistema Atualizado</h3>
<h4 id="grafana-mimir">Grafana Mimir</h4>
<p>Grafana Mimir, um fork do Cortex, amadureceu significativamente e hoje concorre diretamente com Thanos e VictoriaMetrics. Oferece:</p>
<ul>
<li><strong>Alta disponibilidade</strong>: M√∫ltiplas r√©plicas</li>
<li><strong>Reten√ß√£o de longo prazo</strong>: Armazenamento escal√°vel</li>
<li><strong>Compatibilidade PromQL</strong>: Consultas nativas</li>
<li><strong>Integra√ß√£o Grafana</strong>: Dashboard nativo</li>
</ul>
<h4 id="opentelemetry">OpenTelemetry</h4>
<p>OpenTelemetry se tornou o padr√£o de fato para instrumenta√ß√£o. O Prometheus suporta o protocolo OTLP atrav√©s de receivers:</p>


  <pre><code class="language-yaml"># Configura√ß√£o OTLP receiver
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318</code></pre>
 <h4 id="chronosphere">Chronosphere</h4>
<p>Chronosphere emergiu como uma solu√ß√£o comercial robusta, oferecendo:</p>
<ul>
<li><strong>Observabilidade completa</strong>: M√©tricas, logs e traces</li>
<li><strong>Escalabilidade global</strong>: Distribui√ß√£o geogr√°fica</li>
<li><strong>An√°lise avan√ßada</strong>: Machine learning para detec√ß√£o de anomalias</li>
</ul>
<h2 id="conclus√£o">Conclus√£o</h2>
<p>Neste artigo, exploramos em detalhes o Prometheus, desde seus conceitos fundamentais at√© sua arquitetura interna e funcionamento t√©cnico. Vimos como ele implementa um banco de dados de s√©ries temporais eficiente e como gerencia dados tanto em mem√≥ria quanto em disco.</p>
<p>O Prometheus se destaca no ecossistema de monitoramento por sua simplicidade, efici√™ncia e abordagem pull-based, tornando-o uma ferramenta poderosa para monitorar ambientes modernos, especialmente os nativos da nuvem. Sua capacidade de coletar, armazenar e consultar m√©tricas com baixa lat√™ncia permite detectar problemas rapidamente e tomar decis√µes baseadas em dados.</p>
<p>Entretanto, como qualquer ferramenta, o Prometheus tem seus limites, especialmente em termos de escalabilidade e reten√ß√£o de longo prazo. √â por isso que o ecossistema tem evolu√≠do para incluir solu√ß√µes complementares como Thanos, VictoriaMetrics e Cortex, que abordaremos em artigos futuros. A compreens√£o profunda do funcionamento interno do Prometheus apresentada aqui deve ajudar engenheiros e operadores a aproveitar melhor seus recursos, otimizar seu desempenho e evitar armadilhas comuns.</p>
<p>Esperamos que este guia tenha fornecido insights valiosos tanto para iniciantes quanto para usu√°rios experientes do Prometheus, e que sirva como refer√™ncia para implementa√ß√µes bem-sucedidas em seus ambientes de produ√ß√£o.</p>
<hr>
<h2 id="refer√™ncias">Refer√™ncias</h2>
<ul>
<li><strong><a href="https://prometheus.io/docs/introduction/overview/">Documenta√ß√£o Oficial</a></strong></li>
<li><strong><a href="https://www.robustperception.io/blog/">Site da RobustPerception</a></strong></li>
<li><strong><a href="https://www.oreilly.com/library/view/prometheus-up/9781492034131/">Prometheus Up and Running</a></strong></li>
<li><strong><a href="https://www.prometheusbook.com/">Prometheusbook de James Turnbull</a></strong></li>
<li><strong><a href="https://www.oreilly.com/library/view/hands-on-infrastructure-monitoring/9781789612349/">Hands-On Infrastructure Monitoring with Prometheus</a></strong></li>
<li><strong><a href="https://www.oreilly.com/library/view/monitoring-microservices-and/9781484262160/">Monitoring Microservices and Containerized Applications</a></strong></li>
</ul>
<h3 id="prometheus-vs-outras-ferramentas-de-monitoramento">Prometheus vs. Outras Ferramentas de Monitoramento</h3>
<p>Entender como o Prometheus se compara a outras ferramentas populares de monitoramento pode ajudar a escolher a solu√ß√£o certa para seu ambiente:</p>
<table>
  <thead>
      <tr>
          <th>Ferramenta</th>
          <th>Modelo</th>
          <th>Armazenamento</th>
          <th>Foco</th>
          <th>Pontos Fortes</th>
          <th>Limita√ß√µes</th>
          <th>Licen√ßa</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Prometheus</strong></td>
          <td>Pull-based</td>
          <td>TSDB pr√≥prio</td>
          <td>M√©tricas</td>
          <td>Simplicidade, PromQL, ecossistema Cloud Native</td>
          <td>Reten√ß√£o de longo prazo, alta disponibilidade</td>
          <td>Apache 2.0</td>
      </tr>
      <tr>
          <td><strong>Grafana Mimir</strong></td>
          <td>Pull/Push</td>
          <td>Distribu√≠do</td>
          <td>M√©tricas</td>
          <td>Escalabilidade horizontal, compatibilidade com PromQL</td>
          <td>Complexidade de configura√ß√£o</td>
          <td>AGPL-3.0</td>
      </tr>
      <tr>
          <td><strong>VictoriaMetrics</strong></td>
          <td>Pull/Push</td>
          <td>Propriet√°rio</td>
          <td>M√©tricas</td>
          <td>Performance, compress√£o eficiente</td>
          <td>Custo para vers√£o enterprise</td>
          <td>Apache 2.0</td>
      </tr>
      <tr>
          <td><strong>Datadog</strong></td>
          <td>Push-based</td>
          <td>Propriet√°rio</td>
          <td>M√©tricas, logs, traces</td>
          <td>Interface unificada, monitoramento completo</td>
          <td>Custo, c√≥digo fechado</td>
          <td>Propriet√°rio</td>
      </tr>
      <tr>
          <td><strong>New Relic</strong></td>
          <td>Push-based</td>
          <td>Propriet√°rio</td>
          <td>APM, m√©tricas</td>
          <td>Profiling de aplica√ß√µes, dashboards prontos</td>
          <td>Custo, menos flex√≠vel</td>
          <td>Propriet√°rio</td>
      </tr>
      <tr>
          <td><strong>Nagios</strong></td>
          <td>Pull-based</td>
          <td>Relacional</td>
          <td>Verifica√ß√µes de disponibilidade</td>
          <td>Maturidade, extensibilidade</td>
          <td>Configura√ß√£o complexa, visualiza√ß√£o limitada</td>
          <td>GPL-2.0</td>
      </tr>
      <tr>
          <td><strong>ELK Stack</strong></td>
          <td>Push-based</td>
          <td>Elasticsearch</td>
          <td>Logs, m√©tricas</td>
          <td>Pesquisa poderosa, an√°lise de logs</td>
          <td>Consumo de recursos, complexidade</td>
          <td>Apache 2.0</td>
      </tr>
  </tbody>
</table>
<p>O Prometheus se destaca pela sua abordagem n√£o-intrusiva de monitoramento, focando primariamente em m√©tricas num√©ricas e oferecendo uma linguagem de consulta poderosa. √â especialmente adequado para ambientes din√¢micos como Kubernetes, onde servi√ßos v√™m e v√£o constantemente.</p>
<p>Enquanto solu√ß√µes como <a href="https://www.datadoghq.com/">Datadog</a> e <a href="https://newrelic.com/">New Relic</a> oferecem experi√™ncias mais integradas com APM (Application Performance Monitoring) e an√°lise de logs, elas tendem a ser mais caras e menos flex√≠veis. O Prometheus, sendo open source, permite maior personaliza√ß√£o e integra√ß√£o com outras ferramentas de c√≥digo aberto.</p>

    </div>
    
    
    <div class="post-comments">
        <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "scovl" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
    
</article>

        </div>
    </main>
    
    
    
    <footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-links">
                
                <a href="https://github.com/scovl" target="_blank" rel="noopener noreferrer" class="footer-link">
                    GitHub
                </a>
                
                
                
                <a href="https://linkedin.com/in/vitor-lobo" target="_blank" rel="noopener noreferrer" class="footer-link">
                    LinkedIn
                </a>
                
                
                
                <a href="mailto:lobocode@gmail.com" class="footer-link">
                    Email
                </a>
                

                
                <a href="https://hachyderm.io/@lobocode" target="_blank" rel="noopener noreferrer" class="footer-link">
                    Mastodon
                </a>
                

                
                <a href="https://scovl.github.io/index.xml" target="_blank" rel="noopener noreferrer" class="footer-link">
                    RSS
                </a>
                
            </div>
            
            <div class="copyright">
                &copy; 2025 Vitor Lobo
            </div>
        </div>
    </div>
</footer> 
    
    
    
    <script src="/js/main-minimal.js"></script>
    
    
    
</body>
</html> 