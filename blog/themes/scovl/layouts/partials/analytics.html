{{ if .Site.Params.analytics }}
<!-- Web Vitals Tracking -->
<script>
// Web Vitals tracking
(function() {
    'use strict';
    
    // Import web-vitals library
    import('https://unpkg.com/web-vitals@3/dist/web-vitals.js').then(({getCLS, getFID, getFCP, getLCP, getTTFB}) => {
        // Core Web Vitals
        getCLS(console.log);
        getFID(console.log);
        getFCP(console.log);
        getLCP(console.log);
        getTTFB(console.log);
        
        // Send to analytics if configured
        {{ if .Site.Params.analytics.webVitals }}
        function sendToAnalytics(metric) {
            const body = JSON.stringify(metric);
            const url = '{{ .Site.Params.analytics.webVitalsEndpoint | default "/api/web-vitals" }}';
            
            if (navigator.sendBeacon) {
                navigator.sendBeacon(url, body);
            } else {
                fetch(url, {body, method: 'POST', keepalive: true});
            }
        }
        
        getCLS(sendToAnalytics);
        getFID(sendToAnalytics);
        getFCP(sendToAnalytics);
        getLCP(sendToAnalytics);
        getTTFB(sendToAnalytics);
        {{ end }}
    });
})();
</script>

<!-- Performance Monitoring -->
<script>
// Performance monitoring
(function() {
    'use strict';
    
    // Track page load performance
    window.addEventListener('load', function() {
        setTimeout(function() {
            const perfData = performance.getEntriesByType('navigation')[0];
            const metrics = {
                dns: perfData.domainLookupEnd - perfData.domainLookupStart,
                tcp: perfData.connectEnd - perfData.connectStart,
                ttfb: perfData.responseStart - perfData.requestStart,
                domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
                total: perfData.loadEventEnd - perfData.fetchStart
            };
            
            console.log('Performance Metrics:', metrics);
            
            {{ if .Site.Params.analytics.performance }}
            // Send to analytics
            fetch('{{ .Site.Params.analytics.performanceEndpoint | default "/api/performance" }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(metrics)
            });
            {{ end }}
        }, 0);
    });
    
    // Track user interactions
    let interactionCount = 0;
    const trackInteraction = () => {
        interactionCount++;
        if (interactionCount % 10 === 0) { // Track every 10 interactions
            console.log('User Interactions:', interactionCount);
        }
    };
    
    document.addEventListener('click', trackInteraction);
    document.addEventListener('scroll', trackInteraction);
})();
</script>

<!-- Error Boundary -->
<script>
// Error boundary for JavaScript
(function() {
    'use strict';
    
    const originalOnError = window.onerror;
    const originalOnUnhandledRejection = window.onunhandledrejection;
    
    window.onerror = function(message, source, lineno, colno, error) {
        const errorData = {
            type: 'error',
            message: message,
            source: source,
            lineno: lineno,
            colno: colno,
            stack: error ? error.stack : null,
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent
        };
        
        console.error('JavaScript Error:', errorData);
        
        {{ if .Site.Params.analytics.errorTracking }}
        // Send error to analytics
        fetch('{{ .Site.Params.analytics.errorEndpoint | default "/api/errors" }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(errorData)
        }).catch(() => {
            // Fallback to console if analytics fails
            console.error('Failed to send error to analytics');
        });
        {{ end }}
        
        // Call original handler if exists
        if (originalOnError) {
            return originalOnError.apply(this, arguments);
        }
    };
    
    window.onunhandledrejection = function(event) {
        const errorData = {
            type: 'unhandledrejection',
            reason: event.reason,
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent
        };
        
        console.error('Unhandled Promise Rejection:', errorData);
        
        {{ if .Site.Params.analytics.errorTracking }}
        // Send error to analytics
        fetch('{{ .Site.Params.analytics.errorEndpoint | default "/api/errors" }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(errorData)
        }).catch(() => {
            console.error('Failed to send error to analytics');
        });
        {{ end }}
        
        // Call original handler if exists
        if (originalOnUnhandledRejection) {
            return originalOnUnhandledRejection.apply(this, arguments);
        }
    };
})();
</script>

<!-- A/B Testing Framework -->
<script>
// A/B Testing Framework
(function() {
    'use strict';
    
    const ABTesting = {
        experiments: JSON.parse('{{ .Site.Params.analytics.abTesting | default "{}" | jsonify }}'),
        userID: localStorage.getItem('ab_user_id') || 'user_' + Math.random().toString(36).substr(2, 9),
        
        init() {
            localStorage.setItem('ab_user_id', this.userID);
            this.runExperiments();
        },
        
        runExperiments() {
            Object.keys(this.experiments).forEach(experimentName => {
                const experiment = this.experiments[experimentName];
                const variant = this.getVariant(experimentName, experiment.variants);
                
                if (variant) {
                    this.applyVariant(experimentName, variant);
                    this.trackExperiment(experimentName, variant);
                }
            });
        },
        
        getVariant(experimentName, variants) {
            const hash = this.hashCode(this.userID + experimentName);
            const normalizedHash = hash % 100;
            
            let cumulativeWeight = 0;
            for (const variant of variants) {
                cumulativeWeight += variant.weight || 50;
                if (normalizedHash < cumulativeWeight) {
                    return variant;
                }
            }
            
            return variants[0]; // Fallback
        },
        
        applyVariant(experimentName, variant) {
            // Apply CSS classes
            if (variant.classes) {
                document.body.classList.add(...variant.classes);
            }
            
            // Apply custom JavaScript
            if (variant.script) {
                try {
                    eval(variant.script);
                } catch (error) {
                    console.error('A/B Test script error:', error);
                }
            }
            
            // Store variant for tracking
            window.currentABVariant = variant;
        },
        
        trackExperiment(experimentName, variant) {
            const eventData = {
                experiment: experimentName,
                variant: variant.name,
                userID: this.userID,
                timestamp: new Date().toISOString()
            };
            
            console.log('A/B Test Active:', eventData);
            
            {{ if .Site.Params.analytics.abTesting }}
            // Send to analytics
            fetch('{{ .Site.Params.analytics.abEndpoint | default "/api/ab-testing" }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(eventData)
            });
            {{ end }}
        },
        
        trackConversion(experimentName, conversionType) {
            const eventData = {
                experiment: experimentName,
                variant: window.currentABVariant?.name,
                conversion: conversionType,
                userID: this.userID,
                timestamp: new Date().toISOString()
            };
            
            console.log('A/B Test Conversion:', eventData);
            
            {{ if .Site.Params.analytics.abTesting }}
            // Send to analytics
            fetch('{{ .Site.Params.analytics.abEndpoint | default "/api/ab-testing" }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(eventData)
            });
            {{ end }}
        },
        
        hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }
    };
    
    // Initialize A/B testing
    document.addEventListener('DOMContentLoaded', function() {
        ABTesting.init();
    });
    
    // Expose to global scope
    window.ABTesting = ABTesting;
})();
</script>
{{ end }}